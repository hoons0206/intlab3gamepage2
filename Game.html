<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2P 화면</title>
  <style>
    .box {
      width: 50px;
      height: 50px;
      position: absolute;
      top: 100px;
      transition: left 0.1s linear;
    }
    .grey { background-color: grey; }
    .red { background-color: red; }
    .green { background-color: green; }
    .blue { background-color: blue; }
  </style>
</head>
<body>
  <div id="boxContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      // 🔐 실제 프로젝트의 Firebase 설정값으로 교체하세요
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const boxRef = ref(db, 'boxes');
    const waitingRef = ref(db, 'waiting');

    const boxContainer = document.getElementById('boxContainer');
    const boxElements = {};
    let finished = false;
    let successCheckStarted = false;

    function checkIfBoxesCleared() {
      successCheckStarted = true;
      setTimeout(() => {
        if (Object.keys(boxElements).length === 0 && !finished) {
          console.log("🎉 성공!");
          finished = true;
          window.location.href = 'Success.html';
        } else {
          console.log("✅ 박스 있음. 성공 조건 실패.");
          successCheckStarted = false; // 다시 체크할 수 있도록
        }
      }, 3000);
    }

    onValue(boxRef, (snapshot) => {
      const data = snapshot.val();

      // 기존 박스 요소 제거
      for (const key in boxElements) {
        if (!data || !data[key]) {
          boxContainer.removeChild(boxElements[key]);
          delete boxElements[key];
        }
      }

      if (data) {
        for (const key in data) {
          const { type, shape, x } = data[key];

          if (!boxElements[key]) {
            const div = document.createElement('div');
            div.classList.add('box', shape || 'grey');
            boxContainer.appendChild(div);
            boxElements[key] = div;
          }

          const box = boxElements[key];
          box.className = 'box'; // reset classes
          box.classList.add(shape || 'grey');
          box.style.left = `${x}px`;

          // ✅ 실패 조건 (화면을 벗어남) — 성공 체크 중에는 무시
          if (x > window.innerWidth * 0.6) {
            if (!finished && !successCheckStarted) {
              console.log("❌ 실패: 박스가 화면을 벗어남");
              finished = true;
              window.location.href = 'Fail.html';
              return;
            }
          }
        }
      }

      // ✅ 성공 조건: 박스가 모두 없어졌는지 감지
      if (Object.keys(boxElements).length === 0 && !successCheckStarted && !finished) {
        checkIfBoxesCleared();
      }
    });

    // ✅ 1P가 waiting 값을 success로 바꾸면 성공
    onValue(waitingRef, (snapshot) => {
      const value = snapshot.val();
      if (value === 'success' && !finished) {
        console.log("✅ 1P가 성공함 → 성공 처리");
        finished = true;
        window.location.href = 'Success.html';
      }
    });

    // ✅ 타임아웃 실패 조건 (70초)
    setTimeout(() => {
      if (!finished) {
        console.log("❌ 실패: 시간 초과");
        finished = true;
        window.location.href = 'Fail.html';
      }
    }, 70000);
  </script>
</body>
</html>

