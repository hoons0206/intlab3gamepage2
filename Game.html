<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2P í™”ë©´</title>
  <style>
    .box {
      width: 50px;
      height: 50px;
      position: absolute;
      top: 100px;
      transition: left 0.1s linear;
    }
    .grey { background-color: grey; }
    .red { background-color: red; }
    .green { background-color: green; }
    .blue { background-color: blue; }
  </style>
</head>
<body>
  <div id="boxContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      // ğŸ” ì‹¤ì œ í”„ë¡œì íŠ¸ì˜ Firebase ì„¤ì •ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const boxRef = ref(db, 'boxes');
    const waitingRef = ref(db, 'waiting');

    const boxContainer = document.getElementById('boxContainer');
    const boxElements = {};
    let finished = false;
    let successCheckStarted = false;

    function checkIfBoxesCleared() {
      successCheckStarted = true;
      setTimeout(() => {
        if (Object.keys(boxElements).length === 0 && !finished) {
          console.log("ğŸ‰ ì„±ê³µ!");
          finished = true;
          window.location.href = 'Success.html';
        } else {
          console.log("âœ… ë°•ìŠ¤ ìˆìŒ. ì„±ê³µ ì¡°ê±´ ì‹¤íŒ¨.");
          successCheckStarted = false; // ë‹¤ì‹œ ì²´í¬í•  ìˆ˜ ìˆë„ë¡
        }
      }, 3000);
    }

    onValue(boxRef, (snapshot) => {
      const data = snapshot.val();

      // ê¸°ì¡´ ë°•ìŠ¤ ìš”ì†Œ ì œê±°
      for (const key in boxElements) {
        if (!data || !data[key]) {
          boxContainer.removeChild(boxElements[key]);
          delete boxElements[key];
        }
      }

      if (data) {
        for (const key in data) {
          const { type, shape, x } = data[key];

          if (!boxElements[key]) {
            const div = document.createElement('div');
            div.classList.add('box', shape || 'grey');
            boxContainer.appendChild(div);
            boxElements[key] = div;
          }

          const box = boxElements[key];
          box.className = 'box'; // reset classes
          box.classList.add(shape || 'grey');
          box.style.left = `${x}px`;

          // âœ… ì‹¤íŒ¨ ì¡°ê±´ (í™”ë©´ì„ ë²—ì–´ë‚¨) â€” ì„±ê³µ ì²´í¬ ì¤‘ì—ëŠ” ë¬´ì‹œ
          if (x > window.innerWidth * 0.6) {
            if (!finished && !successCheckStarted) {
              console.log("âŒ ì‹¤íŒ¨: ë°•ìŠ¤ê°€ í™”ë©´ì„ ë²—ì–´ë‚¨");
              finished = true;
              window.location.href = 'Fail.html';
              return;
            }
          }
        }
      }

      // âœ… ì„±ê³µ ì¡°ê±´: ë°•ìŠ¤ê°€ ëª¨ë‘ ì—†ì–´ì¡ŒëŠ”ì§€ ê°ì§€
      if (Object.keys(boxElements).length === 0 && !successCheckStarted && !finished) {
        checkIfBoxesCleared();
      }
    });

    // âœ… 1Pê°€ waiting ê°’ì„ successë¡œ ë°”ê¾¸ë©´ ì„±ê³µ
    onValue(waitingRef, (snapshot) => {
      const value = snapshot.val();
      if (value === 'success' && !finished) {
        console.log("âœ… 1Pê°€ ì„±ê³µí•¨ â†’ ì„±ê³µ ì²˜ë¦¬");
        finished = true;
        window.location.href = 'Success.html';
      }
    });

    // âœ… íƒ€ì„ì•„ì›ƒ ì‹¤íŒ¨ ì¡°ê±´ (70ì´ˆ)
    setTimeout(() => {
      if (!finished) {
        console.log("âŒ ì‹¤íŒ¨: ì‹œê°„ ì´ˆê³¼");
        finished = true;
        window.location.href = 'Fail.html';
      }
    }, 70000);
  </script>
</body>
</html>

