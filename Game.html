<body>
<div id="shape-sequence-display"></div>
<div id="conveyor"></div>
<div id="bins" style="text-align:center; margin-top: 20px;">
  <img src="html/media/red_bin.png" id="bin-type1" data-type="type1" class="bin" style="width:80px; margin:10px; cursor:pointer;">
  <img src="html/media/green_bin.png" id="bin-type2" data-type="type2" class="bin" style="width:80px; margin:10px; cursor:pointer;">
  <img src="html/media/blue_bin.png" id="bin-type3" data-type="type3" class="bin" style="width:80px; margin:10px; cursor:pointer;">
  <img src="html/media/yellow_bin.png" id="bin-type4" data-type="type4" class="bin" style="width:80px; margin:10px; cursor:pointer;">
</div>

<script>
  const conveyor = document.getElementById('conveyor');
  const types = ['type1', 'type2', 'type3', 'type4'];
  const boxWidth = 70;
  const speed = 3;
  const frameRate = 1000 / 30;
  const boxes = [];
  let selectedType = null;
  let selectedBox = null;

  const incomingBoxesRef = db.ref('game/2p_incomingBoxes');
  const targetLength = 3;
  let currentSequence = [];
  let currentIndex = 0;

  function generateRandomSequence() {
    const seq = [];
    for (let i = 0; i < targetLength; i++) {
      seq.push(types[Math.floor(Math.random() * types.length)]);
    }
    return seq;
  }

  function displaySequence(seq) {
    const display = document.getElementById('shape-sequence-display');
    display.innerHTML = '';
    seq.forEach(shape => {
      const div = document.createElement('div');
      div.className = `shape-block shape-${shape}`;
      div.style.backgroundColor = '#111';
      display.appendChild(div);
    });
  }

  function resetSequence() {
    currentSequence = generateRandomSequence();
    currentIndex = 0;
    displaySequence(currentSequence);
  }

  resetSequence();

  window.addEventListener("load", () => {
    incomingBoxesRef.orderByChild('timestamp').on('child_added', snapshot => {
      const boxData = snapshot.val();
      const boxId = snapshot.key;

      const imgEl = document.createElement('img');
      imgEl.classList.add('box-img');
      imgEl.style.left = '-70px';

      const imgMap = {
        'type1': ['html/media/red1.png', 'html/media/red2.png'],
        'type2': ['html/media/green1.png', 'html/media/green2.png'],
        'type3': ['html/media/blue1.png', 'html/media/blue2.png'],
        'type4': ['html/media/yellow1.png', 'html/media/yellow2.png']
      };

      const state = boxData.state || '1';
      imgEl.dataset.type = boxData.type;
      imgEl.dataset.state = state;
      imgEl.src = imgMap[boxData.type][state === '2' ? 1 : 0];

      conveyor.appendChild(imgEl);

      const boxObj = {
        id: boxId,
        el: imgEl,
        left: -70,
        originalType: boxData.type,
        currentType: null
      };

      imgEl.addEventListener('click', () => {
        if (imgEl.dataset.state !== '2') {
          alert('📦 박스를 닫아야 분류할 수 있어요!');
          return;
        }
        if (selectedBox && selectedBox.el) {
          selectedBox.el.style.border = 'none';
        }
        selectedBox = boxObj;
        imgEl.style.border = '3px solid yellow';
      });

      boxes.push(boxObj);
    });
  });

  setInterval(() => {
    for (let i = boxes.length - 1; i >= 0; i--) {
      const box = boxes[i];
      box.left += speed;
      box.el.style.left = box.left + 'px';

      if (box.left > window.innerWidth) {
        box.el.remove();
        boxes.splice(i, 1);
      }
    }
  }, frameRate);

  document.querySelectorAll('.bin').forEach(bin => {
    bin.addEventListener('click', () => {
      if (!selectedBox) {
        alert('먼저 박스를 선택해 주세요!');
        return;
      }

      const binType = bin.dataset.type;
      if (selectedBox.el.dataset.type === binType) {
        selectedBox.el.remove();
        boxes.splice(boxes.indexOf(selectedBox), 1);
        selectedBox = null;
      } else {
        alert('박스의 색과 통이 달라요!');
      }
    });
  });
</script>

</body>
</html>
